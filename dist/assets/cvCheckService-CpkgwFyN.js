import{s as i,v as u,g as d}from"./index-BDvsSN8a.js";async function f(n,e,o){console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("[CV-CHECK] ğŸš€ Upload CV fÃ¼r Check gestartet"),console.log("[CV-CHECK] File:",{name:n.name,type:n.type,size:`${(n.size/1024/1024).toFixed(2)} MB`,sizeBytes:n.size});const a=e||crypto.randomUUID();console.log("[CV-CHECK] Upload ID:",a),console.log("[CV-CHECK] User ID:",o||"anonymous");const c=u();if(!c.ok)return console.error("[CV-CHECK] âŒ Webhook validation failed:",c.message),{success:!1,temp_id:a,error:c.message};console.log("[CV-CHECK] âœ… Webhook URL validated");try{const s=d();console.log("[CV-CHECK] URL:",s);const t=new FormData;t.append("file",n),t.append("upload_id",a),o&&t.append("user_id",o),console.log("[CV-CHECK] ğŸ“¦ FormData prepared:"),console.log("[CV-CHECK]   - file: File object"),console.log("[CV-CHECK]   - upload_id:",a),o&&console.log("[CV-CHECK]   - user_id:",o),console.log("[CV-CHECK] ğŸŒ Sende POST Request an Make.com...");const l=await fetch(s,{method:"POST",body:t});if(console.log("[CV-CHECK] ğŸ“¡ Response empfangen:"),console.log("[CV-CHECK]   - Status:",l.status),console.log("[CV-CHECK]   - Status Text:",l.statusText),console.log("[CV-CHECK]   - OK:",l.ok),!l.ok){let C="Keine Fehlermeldung verfÃ¼gbar";try{C=await l.text(),console.error("[CV-CHECK] âŒ Error Response Body:",C)}catch{console.error("[CV-CHECK] âŒ Konnte Error Body nicht lesen")}throw new Error(`Make.com Webhook returned ${l.status} ${l.statusText}. Error: ${C}`)}let r=null;try{const C=await l.text();if(console.log("[CV-CHECK] ğŸ“„ Raw Response (first 500 chars):",C.substring(0,500)),C.trim())try{r=JSON.parse(C),console.log("[CV-CHECK] âœ… JSON Response parsed successfully")}catch{console.log("[CV-CHECK] ğŸ“„ Response is not JSON, treating as text"),r={raw:C}}}catch{console.warn("[CV-CHECK] âš ï¸ Could not read response (this is OK)")}return console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("[CV-CHECK] âœ… UPLOAD ERFOLGREICH"),console.log("[CV-CHECK] Make.com wird den CV jetzt analysieren..."),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),{success:!0,temp_id:a,message:(r==null?void 0:r.message)||"Upload erfolgreich - Make.com analysiert deinen CV jetzt",data:(r==null?void 0:r.ats_json)||null}}catch(s){console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.error("[CV-CHECK] âŒ UPLOAD ERROR"),console.error("[CV-CHECK] Error Type:",s.name),console.error("[CV-CHECK] Error Message:",s.message),console.error("[CV-CHECK] Full Error:",s),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");let t=s.message;return s.message.includes("Failed to fetch")?t="Verbindung zu Make.com fehlgeschlagen. Bitte prÃ¼fe deine Internet-Verbindung und die Webhook-URL.":s.message.includes("NetworkError")&&(t="Netzwerkfehler beim Verbinden zu Make.com. Bitte versuche es spÃ¤ter erneut."),{success:!1,temp_id:a,error:t||"Fehler beim Hochladen. Bitte versuche es erneut."}}}async function E(n){console.log("[CV-CHECK] ğŸ” Fetching analysis for id:",n);try{const{data:e,error:o}=await i.from("stored_cvs").select("id, status, ats_json, error_message, processed_at, file_name").eq("id",n).maybeSingle();if(o)throw console.error("[CV-CHECK] âŒ Query error:",o),o;return e?(console.log("[CV-CHECK] âœ… Daten gefunden:",{id:e.id,status:e.status,has_ats_json:!!e.ats_json,file_name:e.file_name}),e.status==="completed"||!!e.ats_json?!e.ats_json||typeof e.ats_json!="object"?(console.error("[CV-CHECK] âŒ Invalid ats_json structure"),null):e:(console.log("[CV-CHECK] â³ Status:",e.status,"(waiting for completed)"),null)):(console.log("[CV-CHECK] â³ Keine Daten gefunden (noch in Bearbeitung)"),null)}catch(e){throw console.error("[CV-CHECK] âŒ Fetch error:",e),new Error(`Fehler beim Laden der Analyse: ${e.message}`)}}async function K(n,e,o,a,c=3e3,s=40){console.log("[CV-CHECK] ğŸ”„ Starting polling for id:",n),console.log("[CV-CHECK] Polling config:",{intervalMs:c,maxAttempts:s,totalTimeSeconds:c*s/1e3});let t=0;const l=setInterval(async()=>{if(t++,console.log(`[CV-CHECK] ğŸ”„ Polling attempt ${t}/${s}...`),e(t,s),t>=s){console.error("[CV-CHECK] âŒ Polling timeout reached"),clearInterval(l),a();return}try{const r=await E(n);r&&r.ats_json?(console.log("[CV-CHECK] âœ… Analyse komplett!"),clearInterval(l),o(r)):r&&r.status==="failed"&&(console.error("[CV-CHECK] âŒ Analyse fehlgeschlagen"),clearInterval(l),a())}catch(r){console.error("[CV-CHECK] âŒ Polling error:",r)}},c);return()=>{console.log("[CV-CHECK] ğŸ›‘ Polling stopped manually"),clearInterval(l)}}async function H(n,e){console.log("[CV-CHECK] ğŸ”— Linking CV to user:",{uploadId:n,userId:e});try{const{error:o}=await i.from("stored_cvs").update({user_id:e,updated_at:new Date().toISOString()}).eq("id",n);return o?(console.error("[CV-CHECK] âŒ Link error:",o),!1):(console.log("[CV-CHECK] âœ… Successfully linked CV to user"),!0)}catch(o){return console.error("[CV-CHECK] âŒ Link error:",o),!1}}export{E as fetchAnalysisById,H as linkCVToUser,K as pollForAnalysis,f as uploadCvForCheck};
